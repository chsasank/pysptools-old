<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Warm hematite drill core &mdash; PySptools 0.13.4 beta documentation</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.13.4 beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="PySptools 0.13.4 beta documentation" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">PySptools 0.13.4 beta documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="warm-hematite-drill-core">
<h1>Warm hematite drill core<a class="headerlink" href="#warm-hematite-drill-core" title="Permalink to this headline">Â¶</a></h1>
<p>A new version of the hematite example is introduced for the 0.12.0 version. The main improvement is to use FCLS instead of NNLS. With the introduction of FCLS a higher precision is obtained and only four endmembers is needed to map the quartz and, this is new, to define the mask. You can consult the version 0.11.0 for the previous analysis.</p>
<p>Quartz and feldspar have absorption feature in the LWIR range. Hematite (Fe2O3) has no absorption feature in the sensor spectral range. The dark regions correspond to a quartz (SiO2) impurity in the sample (figure 1). The broad spectral feature between 1050 and 1275 cm-1 is associated with the Si-O asymmetric stretching mode of quartz. The cube is acquired in the VLW range of infrared, between 867 to 1288 wavenumber (cm-1) (7.76 to 11.54 micrometer) and it have 165 bands. The instrument used to acquire the data come from the Telops compagny.</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="_images/hem_pic1.png"><img alt="None" src="_images/hem_pic1.png" style="width: 319.0px; height: 227.0px;" /></a>
<p class="caption"><span class="caption-text">Figure 1: image displayed by the Reveal Viewer software at 1113.15 [cm-1].</span></p>
</div>
<p>The analysis is made in tree steps. First, we extract four endmembers. Next, the related abundance maps are generated with FCLS. At the figure 2, you see the extracted endmembers and at the figure 3, the abundance maps.</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="_images/hem_endmembers.png"><img alt="None" src="_images/hem_endmembers.png" style="width: 400.0px; height: 300.0px;" /></a>
<p class="caption"><span class="caption-text">Figure 2: endmembers extracted with NFINDR.</span></p>
</div>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="_images/hem_amaps.png"><img alt="None" src="_images/hem_amaps.png" style="width: 560.0px; height: 420.0px;" /></a>
<p class="caption"><span class="caption-text">Figure 3: abundance maps generated with FCLS.</span></p>
</div>
<p>For the last step we use the EM2 and EM3 spectra to create the mask and the quartz images respectively. Creation of the quartz image is straightforward. The EM2 spectra is a background spectra. Inverting it give a mask for the drill core. At the figure 4 the quartz image is presented and at the figure 5 the mask image.</p>
<div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="_images/hem_quartz.png"><img alt="None" src="_images/hem_quartz.png" style="width: 400.0px; height: 300.0px;" /></a>
<p class="caption"><span class="caption-text">Figure 4: quartz image.</span></p>
</div>
<div class="figure align-center" id="id5">
<a class="reference internal image-reference" href="_images/hem_mask.png"><img alt="None" src="_images/hem_mask.png" style="width: 400.0px; height: 300.0px;" /></a>
<p class="caption"><span class="caption-text">Figure 5: drill core mask.</span></p>
</div>
<p>And the last step consist to extract some statistics. The results are:</p>
<blockquote>
<div><ul class="simple">
<li>Drill core surface (mask) in pixels: 1718</li>
<li>Quartz surface in pixels: 1163</li>
<li>Hematite surface in pixels: 555</li>
</ul>
</div></blockquote>
<p>Code follow:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Plot a quartz class map for a drill core HSI cube.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="kn">as</span> <span class="nn">osp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pysptools.util</span> <span class="kn">as</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">pysptools.eea</span> <span class="kn">as</span> <span class="nn">eea</span>
<span class="kn">import</span> <span class="nn">pysptools.abundance_maps</span> <span class="kn">as</span> <span class="nn">amp</span>


<span class="k">def</span> <span class="nf">parse_ENVI_header</span><span class="p">(</span><span class="n">head</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ax</span><span class="p">[</span><span class="s">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="s">&#39;wavelength&#39;</span><span class="p">]</span>
    <span class="n">ax</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Wavelength - &#39;</span><span class="o">+</span><span class="n">head</span><span class="p">[</span><span class="s">&#39;z plot titles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="s">&#39;z plot titles&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ax</span>


<span class="k">def</span> <span class="nf">get_endmembers</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Endmembers extraction with NFINDR&#39;</span><span class="p">)</span>
    <span class="n">ee</span> <span class="o">=</span> <span class="n">eea</span><span class="o">.</span><span class="n">NFINDR</span><span class="p">()</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ATGP_init</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ee</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">U</span>


<span class="k">def</span> <span class="nf">gen_abundance_maps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">result_path</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Abundance maps with FCLS&#39;</span><span class="p">)</span>
    <span class="n">fcls</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">FCLS</span><span class="p">()</span>
    <span class="n">amap</span> <span class="o">=</span> <span class="n">fcls</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fcls</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="n">colorMap</span><span class="o">=</span><span class="s">&#39;jet&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">amap</span>


<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">img</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;plot_{0}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c"># Load the cube</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PYSPTOOLS_DATA&#39;</span><span class="p">]</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;HOME&#39;</span><span class="p">]</span>
    <span class="n">result_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s">&#39;results&#39;</span><span class="p">)</span>

    <span class="n">sample</span> <span class="o">=</span> <span class="s">&#39;hematite.hdr&#39;</span>

    <span class="n">data_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">load_ENVI_file</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">result_path</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">result_path</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">parse_ENVI_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="c"># Telops cubes are flipped left-right</span>
    <span class="c"># Flipping them again restore the orientation</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">U</span> <span class="o">=</span> <span class="n">get_endmembers</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">result_path</span><span class="p">)</span>
    <span class="n">amaps</span> <span class="o">=</span> <span class="n">gen_abundance_maps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">result_path</span><span class="p">)</span>

    <span class="c"># EM4 == quartz</span>
    <span class="n">quartz</span> <span class="o">=</span> <span class="n">amaps</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">quartz</span><span class="p">,</span> <span class="s">&#39;spectral&#39;</span><span class="p">,</span> <span class="s">&#39;quartz&#39;</span><span class="p">,</span> <span class="n">result_path</span><span class="p">)</span>

    <span class="c"># EM1 == background, we use the backgroud to isolate the drill core</span>
    <span class="c"># and define the mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">amaps</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s">&#39;spectral&#39;</span><span class="p">,</span> <span class="s">&#39;mask&#39;</span><span class="p">,</span> <span class="n">result_path</span><span class="p">)</span>

    <span class="c"># Plot the quartz in color and the hematite in gray</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">quartz</span> <span class="o">&lt;=</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">+</span> <span class="n">quartz</span><span class="p">,</span> <span class="s">&#39;spectral&#39;</span><span class="p">,</span> <span class="s">&#39;hematite+quartz&#39;</span><span class="p">,</span> <span class="n">result_path</span><span class="p">)</span>

    <span class="c"># pixels stat</span>
    <span class="n">rock_surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">quartz_surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">quartz</span> <span class="o">&gt;</span> <span class="mf">0.16</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Some statistics&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;  Drill core surface (mask) in pixels:&#39;</span><span class="p">,</span> <span class="n">rock_surface</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;  Quartz surface in pixels:&#39;</span><span class="p">,</span> <span class="n">quartz_surface</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;  Hematite surface in pixels:&#39;</span><span class="p">,</span> <span class="n">rock_surface</span> <span class="o">-</span> <span class="n">quartz_surface</span><span class="p">)</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">PySptools 0.13.4 beta documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2013-2016, Christian Therien.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>